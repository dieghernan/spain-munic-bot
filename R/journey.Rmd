---
title: "‚úàÔ∏è The Journey"
subtitle: A summary with the codes and executions of the bot
header_type: base
permalink: /journey
datatables: true
output: 
  md_document:
    preserve_yaml: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r count, message=FALSE, warning=FALSE, include=FALSE}

library(mapSpain)
library(sf)
library(dplyr)

datalog <-
  read.csv2("../assets/datalog.csv",
            sep = ",",
            stringsAsFactors = FALSE) %>% select(LAU_CODE_NUM,
                                                 datetime)

data <- esp_get_munic(year = 2019,
                      cache_dir = "data",
                      moveCAN = FALSE) %>%
  st_drop_geometry() %>%
  mutate(LAU_CODE_NUM = as.numeric(LAU_CODE))

been <- nrow(datalog)
notbeen <- nrow(data) - been
been <- prettyNum(been, big.mark = ".", decimal.mark = ",")
notbeen <- prettyNum(notbeen, big.mark = ".", decimal.mark = ",")

```

#### So far I have visited `r been` places üèô. `r notbeen` more to go üëç.


The next table shows the summary of executions of the bot. Note that it is 
sorted by the latest date of execution (datetime).

<img src="https://dieghernan.github.io/spain-munic-bot/assets/img/journey.png" alt="journey-small" style="max-width: 66%;">

You can find the archive on [this folder](https://github.com/dieghernan/spain-munic-bot/tree/main/assets/img). 
The image uses the LAU CODE (similar to [INE codes](https://www.ine.es/daco/daco42/codmun/codmunmapa.htm)) for identifying the municipality
(i.e. `28006_*.png` correspond to Alcobendas images, `28` being the code of Madrid province ).


```{r summary, echo=FALSE, message=FALSE, warning=FALSE}



# LAU_CODE is INE CODE
data <- data %>% filter(!is.na(LAU_CODE))



# Fix names
codauto <-
  esp_codelist %>% select(codauto, ccaa.shortname.es) %>% unique()

cpro <- esp_codelist %>% select(cpro, prov.shortname.es) %>%
  unique()

data <- data %>% left_join(codauto) %>% left_join(cpro)

# Create hashtag
datalog$hashtag <-paste0("spainmunic", sprintf("%05d",datalog$LAU_CODE))

# compose url
datalog$hashtag <- paste0('<a href="https://twitter.com/search/?q=%23',datalog$hashtag,
'">#',
datalog$hashtag,"</a>")

data <- data %>%
  select(codauto,
         ccaa.shortname.es,
         cpro,
         prov.shortname.es,
         LAU_CODE,
         LAU_CODE_NUM,
         name)

# Join

data <- data %>%
  left_join(datalog) 

data[is.na(data$datetime),"datetime"] <- "Not Executed"

data <- data %>% select(datetime, 
hashtag, name, LAU_CODE, prov.shortname.es, ccaa.shortname.es) %>% arrange(LAU_CODE)


knitr::kable(data, format = "html",
             row.names = FALSE,
             col.names = gsub("_","",colnames(data)),
             escape = FALSE,
             table.attr = c("id=\"summary\" class=\"nowrap table table-striped stripe table-sm display compact\""))


```


