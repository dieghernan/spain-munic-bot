---
title: "‚úàÔ∏è The Journey"
subtitle: A summary with the codes and executions of the bot
header_type: base
permalink: /journey
datatables: true
output: 
  md_document:
    preserve_yaml: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r count, message=FALSE, warning=FALSE, include=FALSE}

library(mapSpain)
library(sf)
library(dplyr)

datalog <-
  read.csv2("../assets/datalog.csv",
            sep = ",",
            stringsAsFactors = FALSE) %>% select(LAU_CODE_NUM,
                                                 datetime)

data <- esp_get_munic(year = 2019,
                      cache_dir = "data",
                      moveCAN = FALSE) %>%
  st_drop_geometry() %>%
  mutate(LAU_CODE_NUM = as.numeric(LAU_CODE))

been <- nrow(datalog)
notbeen <- nrow(data) - been

# Assuming cron in minutes

cron <- 30

daysleft <- as.integer(notbeen / (24*60/cron))

d <- as.character(Sys.Date() + daysleft)
 
 

been <- prettyNum(been, big.mark = ".", decimal.mark = ",")
notbeen <- prettyNum(notbeen, big.mark = ".", decimal.mark = ",")

```

#### So far I have visited `r been` places üèô. `r notbeen` more to go üëç.

I think I would finish tweeting on **`r d`**.

<img src="https://dieghernan.github.io/spain-munic-bot/assets/img/journey.png" alt="journey-small" style="max-width: 66%;">

The next table shows the summary of executions of the bot. You would find a link to the hashtag that I used for labelling each town. Just 
follow the hashtag to see the map I tweeted.


```{r summary, echo=FALSE, message=FALSE, warning=FALSE}



# LAU_CODE is INE CODE
data <- data %>% filter(!is.na(LAU_CODE))



# Fix names
codauto <-
  esp_codelist %>% select(codauto, ccaa.shortname.es) %>% unique()

cpro <- esp_codelist %>% select(cpro, prov.shortname.es) %>%
  unique()

data <- data %>% left_join(codauto) %>% left_join(cpro)

# Create hashtag
datalog$hashtag <-paste0("spainmunic", sprintf("%05d",datalog$LAU_CODE))

# compose url
datalog$hashtag <- paste0('<a href="https://twitter.com/search/?q=%23',datalog$hashtag,
'">#',
datalog$hashtag,"</a>")

data <- data %>%
  select(codauto,
         ccaa.shortname.es,
         cpro,
         prov.shortname.es,
         LAU_CODE,
         LAU_CODE_NUM,
         name)

# Join

data <- data %>%
  left_join(datalog) 
  
data[is.na(data$datetime),"hashtag"] <- ""

data[is.na(data$datetime),"datetime"] <- ""

data <- data %>% select(name, 
hashtag, LAU_CODE, prov.shortname.es, ccaa.shortname.es, datetime) %>% arrange(LAU_CODE)


knitr::kable(data, format = "html",
             row.names = FALSE,
             col.names = gsub("_","",colnames(data)),
             escape = FALSE,
             table.attr = c("id=\"summary\" class=\"nowrap table table-striped stripe table-sm display compact\""))


```


